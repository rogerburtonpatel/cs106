#!/bin/bash -x
# 
# Purpose: tests knormal form
# 

## Usage: kntests
## 
## 
## 
## 
## author: rab
## date:  Mon Jan 30 16:04:53 EST 2023

# TODO: use grep conditional capture to print failing tests.

BASEDIR=/h/rburto03/106/student-2023s

SVMDIR=$BASEDIR/src/svm
UFTDIR=$BASEDIR/src/uft
TESTDIR=$BASEDIR/tests/kntests


cd $SVMDIR

# compile if needed
if [[ ! -e $BASEDIR/bin/svm ]]; then
    echo "No svm executable found; compiling..."
    make
    if [[ "$?" -ne "0" ]]; then
        echo "Exiting on compilation failure."
        exit 1
    fi
fi

cd $UFTDIR

if [[ ! -e $BASEDIR/bin/uft ]]; then
    echo "No uft executable found; compiling..."
    make
    if [[ "$?" -ne "0" ]]; then
        echo "Exiting on compilation failure."
        exit 1
    fi
fi

# run tests
run_tests () {
    
    pass=0

    for file in $TESTDIR/*; do
        uft kn-vo $file | svm 2>&1 | grep -v "fail" 
                                                    # grep returns 0 if found
        pass=$((pass + $?))
        echo $pass
    done

    if [[ "$pass" -eq "0" ]]; then 
        echo "All tests passed."
    fi
}

main () {

    run_tests
}

main